# workstation-setup.yml
---
- name: Workstation Setup
  hosts: localhost
  become: yes
  
  vars:
    username: "{{ lookup('env', 'USER') }}"
  
  tasks:
    # Base system
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
    
    # Install prerequisites for Docker repo
    - name: Install Docker prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
    
    # Add Docker GPG key
    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
    
    - name: Add Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
    
    # Add Docker repository
    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
    
    # Install Docker from official repo
    - name: Install Docker Engine
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    # Docker setup
    - name: Add user to docker group
      user:
        name: "{{ username }}"
        groups: docker
        append: yes

    # Start containerd FIRST
    - name: Enable and start containerd service
      systemd:
        name: containerd
        enabled: yes
        state: started

    # Wait a moment for containerd to be ready
    - name: Wait for containerd socket
      wait_for:
        path: /run/containerd/containerd.sock
        state: present
        timeout: 30

    # NOW start Docker
    - name: Enable and start Docker service
      systemd:
        name: docker
        enabled: yes
        state: started
      retries: 3
      delay: 5
      register: docker_start
      until: docker_start is succeeded

    # Development tools
    - name: Install base dev tools
      apt:
        name:
          - build-essential
          - git
          - curl
          - wget
          - vim
          - tmux
          - htop
        state: present

    # Build tools
    - name: Install build tools
      apt:
        name:
          - cmake
          - ninja-build
          - ccache
        state: present

    # SSH setup
    - name: Ensure .ssh directory exists
      file:
        path: "/home/{{ username }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ username }}"
        group: "{{ username }}"

